# Use lightweight Node.js image
FROM node:20-alpine

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Set workspace root
WORKDIR /app

# Copy pnpm metadata first for caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy all packages structure (gets all package.json files automatically)
COPY packages packages

# Copy backend package.json
COPY chess-master-backend/package.json chess-master-backend/

# Install all dependencies (workspace + backend)
RUN pnpm install

# Copy the full repository
COPY . .

# Build all workspace packages that have a build script
RUN pnpm -r --filter './packages/**' run build || true

# Set working directory to backend
WORKDIR /app/chess-master-backend

# Expose backend port
EXPOSE 3004

# Start dev server with nodemon + ts-node
CMD ["pnpm", "dev"]